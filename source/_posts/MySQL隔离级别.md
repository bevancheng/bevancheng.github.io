---
title: MySQL的隔离级别
date: 2022-06-05 18:00:43
tags: MySQL
---

# 关于MySQL的隔离级别

前几天美团的面试问到MySQL的隔离级别、加锁、索引等知识，由于之前没怎么深入学习过数据库，所以答得并不是很好。后来反问环节中，面试官建议可以在学习的时候多思考一下，如果需要自己实现这些功能的话会怎么做，这样进行学习效率会很高。

之后计划跟一下尚硅谷的课程https://www.bilibili.com/video/BV1iq4y1u7vj ，系统性的学习一下MySQL数据库。

<!--more-->

## 隔离级别

### 隔离性

隔离性要求一个事务对数据库中数据的修改，在未提交完成前对于其他事务是不可见的。

SQL标准中定义了四种隔离级别：

- 未提交读
- 已提交读
- 可重复读
- 可串行化

#### 未提交读（READ UNCOMMITED）

未提交读这种隔离级别中，对数据的修改，即使还未提交，对其他的事务也是可见的。事务可以读取未提交的数据，也称为“脏读”，读到的数据为“脏数据”。未提交前，数据是不确定的，可能会被回滚，也可能会有后续操作的变化。

例：发工资时，应发5000，发了10000，但还未提交，员工可以看到自己账户上多了10000，此时财务发现发错了，回滚事务，重新发5000。

#### 已提交读（READ COMMITED）

这个隔离级别是大多数操作系统的默认隔离级别，也是用的最多的。常见Oracle、SQL Server等，但MySQL默认隔离级别是**可重复读**。已提交读满足前面隔离性的简单定义。一个事务对数据所做的修改，只有在提交后才能看到。

例：发工资时，财务声明已经发了工资，但员工查到账户中并无增长，此时可能事务还未完成。过一段时间事务完成，就可以查到。

#### 可重复读（REPEATABLE READ）

这个级别保证了在同一事务中多次读取同样的记录的结果是一致的。相比可重复读这个级别，已提交读又可称为不可重复读。

查询表的隔离界别：`show variables like '%iso%';` `select @@transaction_isolation;`

设置表的隔离级别：`set session transaction isolation level read committed;` 

`read uncommitted`，`repeatable read`，`serializable`

![img](https://raw.githubusercontent.com/bevancheng/imgrepo/main/202206052109527.png?token=AHMFLSEUNLAYZXZ7733BWNLCTSVVM)

此时如果开两个事务，事务1进行查询，事务2进行插入，即使事务2提交了事务，事务1也是查询不到事务2提交了的事务的。

创建表` create table test(num integer);insert into test values(1),(2),(3);`

首先事务1和2都`begin;`，事务2`insert into test values(10);commit;`，此时事务1即使`select * from test;`也是查不到事务2刚刚insert进的数据的，只有事务1也`commit;`后才能查到。

#### 可串行化（SERIALIZABLE）

最高的隔离级别。串行化会在读取的每一行上都加共享锁，所以会导致大量的超时和锁竞争问题。在实际业务中很少会使用这个隔离级别。除非是要求严格数据一致性，才可能会使用。

#### 总结

隔离性从低到高：未提交读，已提交读，可重复读，可串行化。

并发性从低到高：可串行化，可重复读，已提交读，未提交读。

隔离性越高，锁的粒度越细，并发性自然下降。

四种隔离级别采用不同的锁来实现，若读取的是同一数据，可能会发生问题。

脏读（Dirty Read）：某个事务已更新了一份数据，另个事务在此时读取了同一份数据（在未提交读级别可能读到另个事务的未提交数据），由于某些原因，前一事务Rollback了，则后一事务所读取的数据就会是不正确的。

不可重复读（Non-repeatable Read）：在一个事务的两次查询之中数据不同，可能两次查询过程中插入了一个事务更新了原有数据。

幻读（Phantom Read）：在一个事务的两次查询中数据行数不一致，例如一个事务查询了几行数据，而另一个事务在此时插入了新的几行数据，先前的事务在接下来的查询中，就会发现有几行数据是它先前所没有的。

| 隔离级别 | 脏读 | 不可重复读 | 幻读 |
| -------- | ---- | ---------- | ---- |
| 未提交读 | ⚪    | ⚪          | ⚪    |
| 已提交读 | ×    | ⚪          | ⚪    |
| 可重复读 | ×    | ×          | ⚪    |
| 可串行化 | ×    | ×          | ×    |

